#!/usr/bin/env sh

# per gpgconf manual, output is percent-escaped
gnupg-unescape() { IFS= ; read -r val; : "${val//\\/\%5C}"; printf \%q "${_//\%/\\x}"; }

unit-name() { basename "$@" | sed -e 's/^S\.\([[:print:]]*\)$/\1/;s/\./-/g;s/$/.socket/'; }
# TODO: naive socket path generation based on Arch setup
#   - maybe this step is just unecessary
#   - parse and substitute the .socket unit files?
#   - pattern-matching to "unexpand" systemd paths?
unit-socket-path() { echo "$@" | sed -e 's/\/run\/user\/[[:digit:]]*\//%t\//'; }

gitignore="$XDG_CONFIG_HOME/systemd/user/.gitignore"
echo "# Auto-generated gpg-agent socket drop-in" > $gitignore

GNUPGHOME="$XDG_DATA_HOME/gnupg"
gnupgdirnames="dirmngr-socket keyboxd-socket agent-ssh-socket agent-extra-socket agent-browser-socket agent-socket"
units=""

for name in $gnupgdirnames
do
    gpgpath=$(gpgconf --list-dirs "$name" | gnupg-unescape)
    unitname=$(unit-name "${gpgpath}")
    units="$units $unitname"

    dropindir="$XDG_CONFIG_HOME/systemd/user/${unitname}.d"
    [ ! -d "$dropindir" ] && mkdir -p "$dropindir"

    cat <<EOF > "$dropindir/dehome.conf"
[Socket]
ListenStream=
ListenStream=$(unit-socket-path "${gpgpath}")
EOF
    echo "/${unitname}.d/dehome.conf" >> $gitignore
done

cat <<EOF > "$XDG_CONFIG_HOME/environment.d/20-dehome-gpg.conf"
# Auto-generated by \${XDG_BIN_HOME}/generate-gnupg-sockets
GNUPGHOME="\${XDG_DATA_HOME}"/gnupg
SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket | gnupg-unescape)
EOF

systemctl --user daemon-reload
systemctl --user stop $units
systemctl --user stop gpg-agent.service
systemctl --user start $units
systemctl --user start gpg-agent.service
